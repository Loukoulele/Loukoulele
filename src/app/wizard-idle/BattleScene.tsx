"use client";

import { useEffect, useRef, useCallback } from 'react';
import * as PIXI from 'pixi.js';

// ============ DARK DUNGEON BATTLE SCENE - CASTLEVANIA STYLE ============

// Module-level singleton to prevent multiple PIXI instances
let globalPixiApp: PIXI.Application | null = null;
let globalInitPromise: Promise<void> | null = null;

// ===== WIZARD SPRITE (dark mage casting) =====
const WIZARD_SPRITE = {
  palette: [
    '#00000000', '#0a0a12', '#1a1a2e', '#2d2d4a', '#3d3d5c',
    '#4a4a6e', '#d4c4b0', '#b8a898', '#2a2a3a', '#6af', '#4cf'
  ],
  pixels: [
    [0,0,0,0,0,0,0,0,0,8,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,8,8,8,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,8,8,7,7,7,7,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,8,7,6,6,6,6,7,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,8,7,6,6,6,6,7,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,7,6,6,6,6,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,7,6,6,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,4,3,3,2,2,1,0,0,0,0,0,9,10,9,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,3,3,4,4,4,3,3,2,1,0,0,0,9,10,10,10,9,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,4,4,4,4,4,3,2,2,6,6,9,10,10,9,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,3,3,4,4,5,4,4,3,3,6,6,9,10,9,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,3,4,4,5,5,5,4,4,3,6,9,9,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,3,4,4,5,5,5,4,4,3,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,3,4,4,4,5,4,4,4,3,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,3,3,4,4,4,4,4,3,3,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,4,4,4,3,3,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,3,3,3,4,3,3,3,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,3,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,3,3,3,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,3,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,2,0,0,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,2,0,0,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// ===== MONSTER SPRITES (24x24 base, will be scaled up) =====

const LUTIN_SPRITE = {
  palette: ['#00000000','#0d2e0d','#1a4a1a','#2d6a2d','#3d8a3d','#5aaa5a','#7aca7a','#1a1a1a','#ff2222','#ffdd44'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,3,3,3,3,3,3,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,2,3,3,4,4,4,4,3,3,2,0,0,0,0,0,0],
    [0,0,0,0,0,2,2,2,2,3,4,4,5,5,4,4,3,2,2,2,2,0,0,0],
    [0,0,0,0,2,3,3,3,2,3,4,5,5,5,5,4,3,2,3,3,3,2,0,0],
    [0,0,0,2,3,4,4,3,2,3,4,5,6,6,5,4,3,2,3,4,4,3,2,0],
    [0,0,0,2,3,4,3,2,0,2,3,4,5,5,4,3,2,0,2,3,4,3,2,0],
    [0,0,0,0,2,3,2,0,0,2,3,4,4,4,4,3,2,0,0,2,3,2,0,0],
    [0,0,0,0,0,0,0,0,0,2,7,8,4,4,8,7,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,8,8,4,4,8,8,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,3,4,4,4,4,3,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,3,7,9,9,7,3,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,2,3,4,4,3,2,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,2,3,3,3,3,2,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,3,3,4,4,3,3,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,2,3,3,4,4,4,4,3,3,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,2,3,4,4,4,4,4,4,3,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,2,3,4,4,5,5,4,4,3,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,2,3,3,4,4,4,4,3,3,2,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,3,3,4,4,3,3,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,3,3,2,2,3,3,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,2,3,2,0,0,2,3,2,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,0,0,1,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,0,0],
  ]
};

const ARAIGNEE_SPRITE = {
  palette: ['#00000000','#0a0a0a','#1a1a1a','#2a2a2a','#3a3a3a','#4a2a4a','#6a3a6a','#00ff44'],
  pixels: [
    [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],
    [0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0],
    [0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0],
    [1,0,0,0,0,0,1,0,0,2,2,2,2,2,2,0,0,1,0,0,0,0,0,1],
    [0,1,0,0,0,0,0,1,2,3,3,3,3,3,3,2,1,0,0,0,0,0,1,0],
    [0,0,1,0,0,0,0,2,3,3,4,4,4,4,3,3,2,0,0,0,0,1,0,0],
    [0,0,0,1,0,0,2,3,7,7,4,5,5,4,4,3,3,2,0,0,1,0,0,0],
    [0,0,0,0,1,0,2,3,7,7,4,5,6,5,4,3,3,2,0,1,0,0,0,0],
    [0,0,0,0,0,1,2,3,3,4,4,5,6,5,4,4,3,2,1,0,0,0,0,0],
    [0,0,0,0,1,0,2,3,3,4,4,5,5,5,4,4,3,2,0,1,0,0,0,0],
    [0,0,0,1,0,0,2,3,3,4,4,4,4,4,4,3,3,2,0,0,1,0,0,0],
    [0,0,1,0,0,0,0,2,3,3,3,4,4,3,3,3,2,0,0,0,0,1,0,0],
    [0,1,0,0,0,0,0,0,2,2,3,3,3,3,2,2,0,0,0,0,0,0,1,0],
    [1,0,0,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0,0,0,1],
    [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
    [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],
    [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],
    [0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const LOUP_SPRITE = {
  palette: ['#00000000','#2a2a2a','#4a4a4a','#6a6a6a','#8a8a8a','#1a1a1a','#ffcc00'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0],
    [0,0,0,1,2,2,1,0,0,0,0,0,0,0,0,0,0,1,2,2,1,0,0,0],
    [0,0,0,1,2,3,2,1,1,1,1,1,1,1,1,1,1,2,3,2,1,0,0,0],
    [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,3,3,3,3,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,6,2,3,3,3,3,3,3,6,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,6,2,3,3,3,3,3,3,6,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,2,3,3,3,3,3,3,2,2,2,1,0,0,0,0,0],
    [0,0,0,0,1,2,2,2,2,2,3,3,3,3,2,2,2,2,2,1,0,0,0,0],
    [0,0,0,1,2,2,2,2,5,2,2,3,3,2,2,2,2,2,2,2,1,0,0,0],
    [0,0,0,1,2,2,2,5,5,5,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
    [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
    [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,1,0,0,0,0,0,0,1,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,1,0,0,0,0,0,0,0,0,1,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const TROLL_SPRITE = {
  palette: ['#00000000','#2a4a2a','#3a6a3a','#4a8a4a','#1a1a1a','#8b4513','#ff4444'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,6,3,3,6,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,4,4,4,4,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,5,5,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,5,5,5,5,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,3,3,2,2,1,5,5,5,0,0,0],
    [0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,3,2,5,5,5,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,3,3,2,2,5,5,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,5,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,1,1,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,1,0,0,1,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const KRAKEN_SPRITE = {
  palette: ['#00000000','#1a4a6a','#2a6a8a','#3a8aaa','#4aaacc','#22ff66'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,5,3,3,3,3,5,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,5,3,3,3,3,5,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,1,2,1,2,2,1,2,1,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,1,0,1,0,1,1,0,1,0,1,2,1,0,0,0,0,0],
    [0,0,0,0,1,2,1,0,0,0,1,0,0,1,0,0,0,1,2,1,0,0,0,0],
    [0,0,0,1,2,1,0,0,0,0,0,1,1,0,0,0,0,0,1,2,1,0,0,0],
    [0,0,1,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,1,0,0],
    [0,1,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,1,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const SPECTRE_SPRITE = {
  palette: ['#00000000','#aaaacc','#8888aa','#666688','#1a1a3a'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,2,2,2,2,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,2,4,2,2,4,2,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,4,2,2,4,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,3,3,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,2,2,3,3,2,2,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,3,0,2,3,0,0,3,2,0,3,2,1,0,0,0,0,0],
    [0,0,0,0,0,0,3,0,0,3,0,0,0,0,3,0,0,3,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const SQUELETTE_SPRITE = {
  palette: ['#00000000','#ddddcc','#bbbbaa','#999988','#1a1a1a'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,4,1,1,4,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,4,1,1,4,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,1,4,4,1,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,4,4,4,4,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,0,0,0,1,1,1,1,0,0,0,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const VAMPIRE_SPRITE = {
  palette: ['#00000000','#1a1a1a','#2a2a2a','#e8dcd0','#c4b8a8','#ff0000','#880000'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,4,4,4,4,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,4,3,3,3,3,4,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,4,5,3,3,5,4,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,4,3,3,3,3,4,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,4,3,6,6,3,4,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,4,4,4,4,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,1,1,1,1,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,1,1,1,1,2,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,2,2,1,1,1,1,2,2,2,2,1,0,0,0,0,0],
    [0,0,0,0,1,2,2,2,2,2,1,1,1,1,2,2,2,2,2,1,0,0,0,0],
    [0,0,0,0,1,2,2,2,2,2,1,1,1,1,2,2,2,2,2,1,0,0,0,0],
    [0,0,0,0,0,1,2,2,2,2,1,1,1,1,2,2,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,1,1,0,0,1,1,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,0,1,0,0,1,0,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const GARDIEN_SPRITE = {
  palette: ['#00000000','#3a3a3a','#5a5a5a','#7a7a7a','#9a9a9a','#44aaff'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,5,3,3,3,3,5,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,5,3,3,3,3,5,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,3,4,4,3,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,3,3,3,4,4,4,4,3,3,3,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,3,4,4,3,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,1,0,0,1,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,1,0,0,0,0,1,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const DRAGON_SPRITE = {
  palette: ['#00000000','#2a1a1a','#5a2a2a','#8a3a3a','#aa5a5a','#ffaa00','#ffdd44'],
  pixels: [
    [0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,1,0,0,1,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,3,2,1,1,2,3,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,3,3,3,3,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,5,6,5,0,1,2,3,3,5,6,3,3,2,1,0,0,0,0,0,0,0],
    [0,0,5,6,5,6,5,1,2,3,3,3,3,3,3,2,1,0,0,0,0,0,0,0],
    [0,0,0,5,6,5,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,1,0,0,1,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const DEMON_SPRITE = {
  palette: ['#00000000','#4a0a0a','#8a1a1a','#aa3a3a','#ffaa00','#1a1a1a'],
  pixels: [
    [0,0,0,0,0,5,5,0,0,0,0,0,0,0,0,5,5,0,0,0,0,0,0,0],
    [0,0,0,0,5,5,5,5,0,0,0,0,0,0,5,5,5,5,0,0,0,0,0,0],
    [0,0,0,0,0,5,5,5,1,1,1,1,1,1,5,5,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,4,2,2,4,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,4,2,2,4,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,5,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,5,5,0,1,2,2,3,3,3,3,2,2,1,0,5,5,0,0,0,0,0],
    [0,0,5,5,5,5,1,2,3,3,3,3,3,3,2,1,5,5,5,5,0,0,0,0],
    [0,0,0,5,5,0,1,2,2,3,3,3,3,2,2,1,0,5,5,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

const FAUCHEUR_SPRITE = {
  palette: ['#00000000','#0a0a0a','#1a1a1a','#2a2a2a','#888888','#aaaaaa'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,4,4,4,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,4,5,5,5,4,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,4,5,4,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,1,2,2,1,2,1,0,0,0,4,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,4,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,4,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,4,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,4,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,4,4,4,4,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 5: Goule (zombie vert décomposé)
const GOULE_SPRITE = {
  palette: ['#00000000','#1a3a1a','#2a5a2a','#3a7a3a','#4a9a4a','#1a1a1a','#882222'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,6,3,3,6,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,6,3,3,6,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,5,5,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,0,2,3,3,3,3,3,3,2,0,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,0,0,2,2,3,3,3,3,2,2,0,0,1,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 10: Golem de Pierre (statue massive)
const GOLEM_SPRITE = {
  palette: ['#00000000','#3a3a3a','#5a5a5a','#7a7a7a','#9a9a9a','#2a2a2a','#ffaa00'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,6,3,3,3,3,6,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,6,3,3,3,3,6,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,5,5,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,3,4,4,3,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,1,2,2,3,3,3,4,4,4,4,3,3,3,2,2,1,0,0,0,0],
    [0,0,0,0,1,2,2,3,3,3,3,4,4,3,3,3,3,2,2,1,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,3,3,3,3,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,1,0,0,0,0,1,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 11: Salamandre (lézard de feu)
const SALAMANDRE_SPRITE = {
  palette: ['#00000000','#aa2200','#dd4400','#ff6600','#ff9900','#ffcc00','#1a1a1a'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,5,5,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,5,4,4,5,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,6,6,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,4,4,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,2,3,3,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,1,2,2,2,2,1,1,0,0,0,1,1,1,0,0,0],
    [0,0,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0,1,2,2,1,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,1,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 13: Géant de Glace
const GEANT_SPRITE = {
  palette: ['#00000000','#4a6a8a','#6a8aaa','#8aaacc','#aaccee','#2244ff','#1a1a3a'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,6,6,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,4,4,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,4,4,4,4,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,3,4,4,3,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,3,3,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,1,0,0,1,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,1,0,0,0,0,1,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 14: Djinn (esprit du vent)
const DJINN_SPRITE = {
  palette: ['#00000000','#2a4a6a','#4a7aaa','#6aaadd','#aaddff','#ffffff','#ffcc00'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,4,3,3,4,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,6,3,3,6,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,4,1,2,2,3,3,3,3,2,2,1,4,0,0,0,0,0,0],
    [0,0,0,0,0,4,3,2,2,3,3,3,3,3,3,2,2,3,4,0,0,0,0,0],
    [0,0,0,0,0,0,4,1,2,2,3,3,3,3,2,2,1,4,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 15: Chevalier Noir
const CHEVALIER_SPRITE = {
  palette: ['#00000000','#1a1a1a','#2a2a2a','#3a3a3a','#4a4a4a','#aa0000','#666666'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,4,4,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,6,6,6,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,6,6,6,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,4,4,3,3,2,2,1,6,6,0,0,0,0],
    [0,0,0,0,0,0,1,2,3,3,4,4,4,4,3,3,6,6,6,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,4,4,3,3,6,6,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,6,6,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,1,1,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,1,0,0,1,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 16: Liche (mage mort-vivant avec couronne)
const LICHE_SPRITE = {
  palette: ['#00000000','#1a1a2a','#2a2a4a','#3a3a6a','#6666aa','#44ff88','#ffdd00'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,6,0,6,6,0,6,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,1,1,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,5,2,2,3,3,4,4,3,3,2,2,5,0,0,0,0,0,0],
    [0,0,0,0,0,5,0,1,2,2,3,4,4,3,2,2,1,0,5,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 17: Nécromant (mage sombre avec bâton)
const NECROMANT_SPRITE = {
  palette: ['#00000000','#0a0a1a','#1a1a3a','#2a2a5a','#4a4a8a','#aa44ff','#44ff44'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,5,5,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,5,6,5,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,5,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,5,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,5,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,1,1,2,2,1,0,0,0,0,5,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,5,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,5,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,5,5,5,5,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,4,4,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,3,3,4,4,4,4,3,3,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,4,4,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 19: Archange Déchu (ailes brisées)
const ARCHANGE_SPRITE = {
  palette: ['#00000000','#2a2a3a','#4a4a5a','#6a6a7a','#8a8aaa','#ffdd00','#ff4444'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,5,5,5,5,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,6,3,3,6,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,1,1,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,1,1,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,1,1,0,0],
    [0,1,2,2,1,0,1,2,2,3,3,4,4,3,3,2,2,1,0,1,2,2,1,0],
    [0,0,1,2,2,1,1,2,3,3,4,4,4,4,3,3,2,1,1,2,2,1,0,0],
    [0,0,0,1,2,1,0,1,2,2,3,4,4,3,2,2,1,0,1,2,1,0,0,0],
    [0,0,0,0,1,0,0,0,1,2,2,3,3,2,2,1,0,0,0,1,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 20: Entité Alpha (créature cosmique)
const ENTITE_SPRITE = {
  palette: ['#00000000','#1a1a3a','#3a3a6a','#6a4aaa','#aa6aee','#ffffff','#ff44ff'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,4,3,3,4,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,4,0,0,1,2,2,3,3,2,2,1,0,0,4,0,0,0,0,0],
    [0,0,0,0,4,3,4,1,2,2,3,4,4,3,2,2,1,4,3,4,0,0,0,0],
    [0,0,0,0,0,4,0,1,2,3,4,4,4,4,3,2,1,0,4,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,3,4,4,3,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,3,3,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1,2,2,1,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 21: Chrono-Bête (créature temporelle avec sablier)
const CHRONO_SPRITE = {
  palette: ['#00000000','#3a3a2a','#6a6a4a','#9a9a6a','#cccc8a','#ffdd00','#44aaff'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,5,4,4,4,4,5,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,5,4,4,5,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,5,5,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,5,4,4,5,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,5,4,4,4,4,5,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,5,5,5,5,5,5,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,6,3,3,6,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,3,3,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 22: Vide Incarné (trou noir)
const VIDE_SPRITE = {
  palette: ['#00000000','#0a0a0a','#1a1a2a','#2a2a4a','#4a3a6a','#6a4a8a','#aa66cc'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,5,5,5,5,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,5,4,4,4,4,5,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,5,4,3,3,3,3,4,5,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,5,4,3,2,2,2,2,3,4,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,5,4,3,2,1,1,2,3,4,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,5,4,3,2,1,1,2,3,4,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,5,4,3,2,1,1,2,3,4,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,5,4,3,2,1,1,2,3,4,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,5,4,3,2,2,2,2,3,4,5,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,5,4,3,3,3,3,4,5,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,5,4,4,4,4,5,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,5,5,5,5,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 23: Titan du Chaos (géant de feu et ténèbres)
const TITAN_SPRITE = {
  palette: ['#00000000','#2a1a1a','#5a2a2a','#8a3a3a','#cc5a5a','#ff8844','#ffcc00'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,6,0,0,0,0,6,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,6,6,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,3,3,3,3,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,4,4,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,4,5,5,4,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,1,2,2,3,3,4,5,5,4,3,3,2,2,1,0,0,0,0,0],
    [0,0,0,0,0,0,1,2,2,3,3,4,4,3,3,2,2,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,2,3,3,2,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,2,1,0,0,1,2,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,1,2,1,0,0,0,0,1,2,1,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Zone 24: L'Éternel (être de lumière pure)
const ETERNEL_SPRITE = {
  palette: ['#00000000','#6a6a8a','#8a8aaa','#aaaacc','#ccccee','#ffffff','#ffdd44'],
  pixels: [
    [0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,6,5,5,5,5,6,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,5,3,3,5,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,5,5,0,0,0,1,2,2,3,3,2,2,1,0,0,0,5,5,0,0,0],
    [0,0,5,4,4,5,0,1,2,2,3,4,4,3,2,2,1,0,5,4,4,5,0,0],
    [0,0,5,4,3,4,5,1,2,3,4,5,5,4,3,2,1,5,4,3,4,5,0,0],
    [0,0,0,5,4,5,0,1,2,2,3,4,4,3,2,2,1,0,5,4,5,0,0,0],
    [0,0,0,0,5,0,0,0,1,2,2,3,3,2,2,1,0,0,0,5,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,2,1,1,2,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  ]
};

// Monster sprites mapping by zone - ALL 25 UNIQUE
const MOB_SPRITES: { [key: number]: typeof LUTIN_SPRITE } = {
  0: LUTIN_SPRITE,
  1: ARAIGNEE_SPRITE,
  2: LOUP_SPRITE,
  3: TROLL_SPRITE,
  4: KRAKEN_SPRITE,
  5: GOULE_SPRITE,
  6: SPECTRE_SPRITE,
  7: SQUELETTE_SPRITE,
  8: VAMPIRE_SPRITE,
  9: GARDIEN_SPRITE,
  10: GOLEM_SPRITE,
  11: SALAMANDRE_SPRITE,
  12: DRAGON_SPRITE,
  13: GEANT_SPRITE,
  14: DJINN_SPRITE,
  15: CHEVALIER_SPRITE,
  16: LICHE_SPRITE,
  17: NECROMANT_SPRITE,
  18: DEMON_SPRITE,
  19: ARCHANGE_SPRITE,
  20: ENTITE_SPRITE,
  21: CHRONO_SPRITE,
  22: VIDE_SPRITE,
  23: TITAN_SPRITE,
  24: ETERNEL_SPRITE,
};

// ============ CENTRALIZED PARTICLE SYSTEM ============
// Replaces 30-50+ individual requestAnimationFrame loops with a single ticker callback

interface ActiveParticle {
  obj: PIXI.Container;
  container: PIXI.Container;
  vx: number;
  vy: number;
  fadeRate: number;
  scaleDecay: number;
  grow: number;
}

interface ActiveProjectile {
  obj: PIXI.Container;
  container: PIXI.Container;
  startX: number;
  startY: number;
  endX: number;
  endY: number;
  startTime: number;
  duration: number;
  arcHeight: number;
  trailFn?: () => void;
  onComplete: () => void;
}

const _particles: ActiveParticle[] = [];
const _projectiles: ActiveProjectile[] = [];
let _particleTickerAdded = false;


function addParticle(
  obj: PIXI.Container,
  container: PIXI.Container,
  opts: { vx?: number; vy?: number; fadeRate?: number; scaleDecay?: number; grow?: number; delay?: number } = {}
) {
  const p: ActiveParticle = {
    obj, container,
    vx: opts.vx || 0, vy: opts.vy || 0,
    fadeRate: opts.fadeRate || 0.06,
    scaleDecay: opts.scaleDecay || 1,
    grow: opts.grow || 0
  };
  if (opts.delay) {
    setTimeout(() => { _particles.push(p); }, opts.delay);
  } else {
    _particles.push(p);
  }
}

function addProjectile(
  obj: PIXI.Container,
  container: PIXI.Container,
  opts: { startX: number; startY: number; endX: number; endY: number; duration: number; arcHeight?: number; trailFn?: () => void; onComplete: () => void }
) {
  _projectiles.push({
    obj, container,
    startX: opts.startX, startY: opts.startY,
    endX: opts.endX, endY: opts.endY,
    startTime: performance.now(), duration: opts.duration,
    arcHeight: opts.arcHeight || 0,
    trailFn: opts.trailFn, onComplete: opts.onComplete
  });
}

function setupParticleTicker(app: PIXI.Application) {
  if (_particleTickerAdded) return;
  _particleTickerAdded = true;

  app.ticker.add(() => {
    // Update simple particles
    for (let i = _particles.length - 1; i >= 0; i--) {
      const p = _particles[i];
      p.obj.x += p.vx;
      p.obj.y += p.vy;
      p.obj.alpha -= p.fadeRate;
      if (p.scaleDecay !== 1) {
        p.obj.scale.x *= p.scaleDecay;
        p.obj.scale.y *= p.scaleDecay;
      }
      if (p.grow !== 0) {
        p.obj.scale.x += p.grow;
        p.obj.scale.y += p.grow;
      }
      if (p.obj.alpha <= 0) {
        p.container.removeChild(p.obj);
        p.obj.destroy();
        _particles.splice(i, 1);
      }
    }

    // Update projectiles
    const now = performance.now();
    for (let i = _projectiles.length - 1; i >= 0; i--) {
      const proj = _projectiles[i];
      const elapsed = now - proj.startTime;
      const progress = Math.min(elapsed / proj.duration, 1);

      proj.obj.x = proj.startX + (proj.endX - proj.startX) * progress;
      proj.obj.y = proj.startY + (proj.endY - proj.startY) * progress;
      if (proj.arcHeight) {
        proj.obj.y -= Math.sin(progress * Math.PI) * proj.arcHeight;
      }

      if (proj.trailFn && Math.random() > 0.5) proj.trailFn();

      if (progress >= 1) {
        proj.onComplete();
        _projectiles.splice(i, 1);
      }
    }

  });
}

// Create texture from pixel array
function createSpriteTexture(
  spriteData: { palette: string[]; pixels: number[][] },
  app: PIXI.Application,
  scale: number = 4
): PIXI.Texture {
  const pixels = spriteData.pixels;
  const palette = spriteData.palette;
  const height = pixels.length;
  const width = pixels[0].length;
  const graphics = new PIXI.Graphics();

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const colorIdx = pixels[y][x];
      if (colorIdx > 0) {
        const color = palette[colorIdx];
        graphics.rect(x * scale, y * scale, scale, scale);
        graphics.fill(color);
      }
    }
  }

  return app.renderer.generateTexture(graphics);
}

// Draw dungeon background
function drawDungeonBackground(app: PIXI.Application): PIXI.Container {
  const bg = new PIXI.Container();

  // Base dark background
  const baseBg = new PIXI.Graphics();
  baseBg.rect(0, 0, 500, 300);
  baseBg.fill(0x0a0a12);
  bg.addChild(baseBg);

  // Back wall with stone pattern
  const wall = new PIXI.Graphics();
  const stoneColors = [0x1a1a24, 0x22222e, 0x181820, 0x202030];

  for (let row = 0; row < 4; row++) {
    for (let col = 0; col < 12; col++) {
      const x = col * 45 + (row % 2) * 22;
      const y = row * 35;
      const w = 42;
      const h = 32;
      const color = stoneColors[(row + col) % stoneColors.length];

      wall.rect(x, y, w, h);
      wall.fill(color);
      wall.rect(x, y, w, 2);
      wall.fill(0x0a0a10);
      wall.rect(x, y, 2, h);
      wall.fill(0x0a0a10);
      wall.rect(x + 2, y + h - 2, w - 2, 2);
      wall.fill(0x2a2a3a);
    }
  }
  bg.addChild(wall);

  // Mysterious eye/portal
  const eyeX = 250, eyeY = 70;
  const eyeGlow = new PIXI.Graphics();
  eyeGlow.circle(eyeX, eyeY, 35);
  eyeGlow.fill({ color: 0x4a2a6a, alpha: 0.3 });
  bg.addChild(eyeGlow);

  const eyeSocket = new PIXI.Graphics();
  eyeSocket.ellipse(eyeX, eyeY, 30, 20);
  eyeSocket.fill(0x1a0a2a);
  bg.addChild(eyeSocket);

  const eyePupil = new PIXI.Graphics();
  eyePupil.circle(eyeX, eyeY, 8);
  eyePupil.fill(0x8844aa);
  bg.addChild(eyePupil);

  // Floor - cobblestones
  const floor = new PIXI.Graphics();
  const floorY = 140;
  floor.rect(0, floorY, 500, 160);
  floor.fill(0x2a2a3a);

  for (let row = 0; row < 8; row++) {
    const yPos = floorY + row * 22;
    const stoneHeight = 18 + row;
    const stoneWidth = 35 + row * 5;
    for (let col = 0; col < 15; col++) {
      const xOffset = (row % 2) * (stoneWidth / 2);
      const x = col * stoneWidth - xOffset;
      const color = (row + col) % 3 === 0 ? 0x3a3a4a : 0x32323e;
      floor.rect(x + 2, yPos + 2, stoneWidth - 4, stoneHeight - 4);
      floor.fill(color);
    }
  }
  bg.addChild(floor);

  return bg;
}

interface BattleSceneProps {
  onReady?: (api: BattleAPI) => void;
  currentZone?: number;
}

export interface BattleAPI {
  castSpell: (spellType?: string) => void;
  hitMob: () => void;
  setMobName: (name: string) => void;
  setZone: (zone: number) => void;
}

export default function BattleScene({ onReady, currentZone = 0 }: BattleSceneProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  const appRef = useRef<PIXI.Application | null>(null);
  const mobRef = useRef<PIXI.Sprite | null>(null);
  const wizardRef = useRef<PIXI.Sprite | null>(null);
  const particlesRef = useRef<PIXI.Container | null>(null);
  const currentZoneRef = useRef<number>(currentZone);
  const onReadyRef = useRef(onReady);
  onReadyRef.current = onReady;

  const castSpell = useCallback((spellType: string = 'fulgur') => {
    const app = appRef.current;
    const particles = particlesRef.current;
    const wizard = wizardRef.current;
    if (!app || !particles || !wizard) return;

    const wizardBaseX = 80, wizardBaseY = 260;
    const mobBaseX = 380, mobBaseY = 220;
    const startX = wizardBaseX + 48, startY = wizardBaseY - 115;
    const endX = mobBaseX - 20, endY = mobBaseY - 30;

    // Wizard cast animation
    const animWizard = wizard as unknown as PIXI.AnimatedSprite & { _idleFrames?: PIXI.Texture[]; _castFrames?: PIXI.Texture[] };
    if (animWizard._castFrames && animWizard._idleFrames) {
      animWizard.textures = animWizard._castFrames;
      animWizard.animationSpeed = 0.15;
      animWizard.play();
      setTimeout(() => {
        animWizard.textures = animWizard._idleFrames!;
        animWizard.animationSpeed = 0.08;
        animWizard.play();
      }, 600);
    }
    wizard.x = wizardBaseX + 5;
    setTimeout(() => { wizard.x = wizardBaseX; }, 150);

    // ============ FULGUR - Lightning Bolt ============
    if (spellType === 'fulgur') {
      const lightning = new PIXI.Graphics();
      const points: {x: number, y: number}[] = [];
      const segments = 8;

      for (let i = 0; i <= segments; i++) {
        const t = i / segments;
        const x = startX + (endX - startX) * t;
        const y = startY + (endY - startY) * t;
        const offset = i === 0 || i === segments ? 0 : (Math.random() - 0.5) * 30;
        points.push({ x: x + offset * 0.3, y: y + offset });
      }

      lightning.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length; i++) lightning.lineTo(points[i].x, points[i].y);
      lightning.stroke({ width: 4, color: 0x4fc3f7, alpha: 0.9 });
      lightning.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length; i++) lightning.lineTo(points[i].x, points[i].y);
      lightning.stroke({ width: 2, color: 0xffffff, alpha: 1 });
      lightning.circle(endX, endY, 15);
      lightning.fill({ color: 0x4fc3f7, alpha: 0.3 });
      particles.addChild(lightning);

      // Sparks at impact
      for (let i = 0; i < 5; i++) {
        const spark = new PIXI.Graphics();
        spark.moveTo(0, 0);
        spark.lineTo(Math.random() * 20 - 10, Math.random() * 20 - 10);
        spark.stroke({ width: 2, color: 0x4fc3f7, alpha: 0.8 });
        spark.x = endX; spark.y = endY;
        particles.addChild(spark);
        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 3;
        addParticle(spark, particles, { vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, fadeRate: 0.08, delay: 50 });
      }

      // Fade lightning
      addParticle(lightning, particles, { fadeRate: 0.15, delay: 100 });
    }

    // ============ AEGIS - Silver Deer ============
    else if (spellType === 'aegis') {
      const aegis = new PIXI.Graphics();
      aegis.moveTo(0, 0); aegis.lineTo(15, -5); aegis.lineTo(20, -15);
      aegis.moveTo(15, -5); aegis.lineTo(25, -12);
      aegis.moveTo(15, -5); aegis.lineTo(25, 0); aegis.lineTo(30, 10);
      aegis.lineTo(25, 10); aegis.lineTo(20, 5); aegis.lineTo(10, 5);
      aegis.lineTo(5, 10); aegis.lineTo(0, 10); aegis.lineTo(0, 0);
      aegis.stroke({ width: 3, color: 0xffffff, alpha: 0.9 });
      aegis.fill({ color: 0xe0e0e0, alpha: 0.4 });
      aegis.circle(15, 0, 25);
      aegis.fill({ color: 0xffffff, alpha: 0.2 });
      aegis.x = startX; aegis.y = startY;
      particles.addChild(aegis);

      addProjectile(aegis, particles, {
        startX, startY, endX, endY, duration: 250,
        trailFn: () => {
          const trail = new PIXI.Graphics();
          trail.circle(0, 0, 4 + Math.random() * 4);
          trail.fill({ color: 0xffffff, alpha: 0.6 });
          trail.x = aegis.x + Math.random() * 10 - 5;
          trail.y = aegis.y + Math.random() * 10 - 5;
          particles.addChild(trail);
          addParticle(trail, particles, { fadeRate: 0.08, scaleDecay: 0.95 });
        },
        onComplete: () => {
          for (let i = 0; i < 8; i++) {
            const light = new PIXI.Graphics();
            light.circle(0, 0, 3);
            light.fill({ color: 0xffffff, alpha: 0.8 });
            light.x = endX; light.y = endY;
            particles.addChild(light);
            const angle = Math.random() * Math.PI * 2;
            const speed = 4 + Math.random() * 5;
            addParticle(light, particles, { vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, fadeRate: 0.04 });
          }
          particles.removeChild(aegis);
          aegis.destroy();
        }
      });
    }

    // ============ IGNIS - Fireball ============
    else if (spellType === 'ignis') {
      const fireball = new PIXI.Graphics();
      fireball.circle(0, 0, 8); fireball.fill({ color: 0xffff00, alpha: 1 });
      fireball.circle(0, 0, 12); fireball.fill({ color: 0xff8800, alpha: 0.8 });
      fireball.circle(0, 0, 16); fireball.fill({ color: 0xff4400, alpha: 0.5 });
      fireball.x = startX; fireball.y = startY;
      particles.addChild(fireball);

      const fireColors = [0xff4400, 0xff8800, 0xffcc00];

      addProjectile(fireball, particles, {
        startX, startY, endX, endY, duration: 200, arcHeight: 20,
        trailFn: () => {
          const flame = new PIXI.Graphics();
          const size = 5 + Math.random() * 8;
          flame.moveTo(0, -size); flame.lineTo(size * 0.5, 0);
          flame.lineTo(0, size * 0.3); flame.lineTo(-size * 0.5, 0); flame.closePath();
          flame.fill({ color: fireColors[Math.floor(Math.random() * 3)], alpha: 0.7 });
          flame.x = fireball.x + Math.random() * 10 - 5;
          flame.y = fireball.y + Math.random() * 10 - 5;
          flame.rotation = Math.random() * Math.PI;
          particles.addChild(flame);
          addParticle(flame, particles, { vy: -1, fadeRate: 0.1, scaleDecay: 0.9 });
        },
        onComplete: () => {
          for (let i = 0; i < 12; i++) {
            const ember = new PIXI.Graphics();
            ember.circle(0, 0, 2 + Math.random() * 4);
            ember.fill({ color: fireColors[Math.floor(Math.random() * 3)], alpha: 0.9 });
            ember.x = endX; ember.y = endY;
            particles.addChild(ember);
            const angle = Math.random() * Math.PI * 2;
            const speed = 5 + Math.random() * 7;
            addParticle(ember, particles, { vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed - 2, fadeRate: 0.04 });
          }
          const ring = new PIXI.Graphics();
          ring.circle(0, 0, 10);
          ring.stroke({ width: 4, color: 0xff8800, alpha: 0.8 });
          ring.x = endX; ring.y = endY;
          particles.addChild(ring);
          addParticle(ring, particles, { fadeRate: 0.1, grow: 0.3 });
          particles.removeChild(fireball);
          fireball.destroy();
        }
      });
    }

    // ============ MORTALIS - Death Ray ============
    else if (spellType === 'mortalis') {
      const beam = new PIXI.Graphics();
      beam.moveTo(startX, startY); beam.lineTo(endX, endY);
      beam.stroke({ width: 8, color: 0x00ff00, alpha: 0.3 });
      beam.moveTo(startX, startY); beam.lineTo(endX, endY);
      beam.stroke({ width: 4, color: 0x44ff44, alpha: 0.6 });
      beam.moveTo(startX, startY); beam.lineTo(endX, endY);
      beam.stroke({ width: 2, color: 0xaaffaa, alpha: 1 });
      particles.addChild(beam);

      // Death particles along beam
      for (let i = 0; i < 8; i++) {
        setTimeout(() => {
          const t = Math.random();
          const deathP = new PIXI.Graphics();
          deathP.circle(0, -2, 4); deathP.fill({ color: 0x00ff00, alpha: 0.7 });
          deathP.circle(-2, 0, 1.5); deathP.circle(2, 0, 1.5);
          deathP.fill({ color: 0x003300, alpha: 1 });
          deathP.x = startX + (endX - startX) * t;
          deathP.y = startY + (endY - startY) * t;
          particles.addChild(deathP);
          addParticle(deathP, particles, { vy: -1 - Math.random() * 2, fadeRate: 0.05 });
        }, i * 20);
      }

      // Impact explosion
      setTimeout(() => {
        for (let i = 0; i < 10; i++) {
          const dark = new PIXI.Graphics();
          dark.circle(0, 0, 3 + Math.random() * 3);
          dark.fill({ color: i % 2 === 0 ? 0x00ff00 : 0x004400, alpha: 0.8 });
          dark.x = endX; dark.y = endY;
          particles.addChild(dark);
          const angle = Math.random() * Math.PI * 2;
          const speed = 4 + Math.random() * 5;
          addParticle(dark, particles, { vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, fadeRate: 0.05 });
        }
        const shock = new PIXI.Graphics();
        shock.circle(0, 0, 8);
        shock.stroke({ width: 3, color: 0x00ff00, alpha: 0.8 });
        shock.x = endX; shock.y = endY;
        particles.addChild(shock);
        addParticle(shock, particles, { fadeRate: 0.08, grow: 0.4 });
      }, 50);

      // Fade beam
      addParticle(beam, particles, { fadeRate: 0.1, delay: 150 });
    }

    // ============ DEFAULT (fallback) ============
    else {
      const spell = new PIXI.Graphics();
      spell.circle(0, 0, 10);
      spell.fill({ color: 0x8866ff, alpha: 0.8 });
      spell.x = startX; spell.y = startY;
      particles.addChild(spell);

      addProjectile(spell, particles, {
        startX, startY, endX, endY, duration: 200,
        onComplete: () => {
          particles.removeChild(spell);
          spell.destroy();
          for (let i = 0; i < 6; i++) {
            const p = new PIXI.Graphics();
            p.circle(0, 0, 3);
            p.fill({ color: 0x8866ff, alpha: 0.7 });
            p.x = endX; p.y = endY;
            particles.addChild(p);
            const angle = Math.random() * Math.PI * 2;
            const speed = 3 + Math.random() * 3;
            addParticle(p, particles, { vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, fadeRate: 0.06 });
          }
        }
      });
    }
  }, []);

  const hitMob = useCallback(() => {
    const mob = mobRef.current;
    const particles = particlesRef.current;
    if (!mob) return;
    const baseX = 380;
    // Flash white then red
    mob.tint = 0xffffff;
    mob.x = baseX + 10;
    mob.scale.y *= 0.95;
    setTimeout(() => { mob.tint = 0xff6666; mob.x = baseX - 6; }, 40);
    setTimeout(() => { mob.tint = 0xff8888; mob.x = baseX + 3; mob.scale.y = mob.scale.x < 0 ? -Math.abs(mob.scale.y / 0.95) : Math.abs(mob.scale.y / 0.95); }, 80);
    setTimeout(() => { mob.tint = 0xffffff; mob.x = baseX; }, 130);
    // Hit sparks
    if (particles) {
      for (let i = 0; i < 3; i++) {
        const spark = new PIXI.Graphics();
        spark.circle(0, 0, 2 + Math.random() * 2);
        spark.fill({ color: 0xffaa44, alpha: 0.9 });
        spark.x = baseX + Math.random() * 20 - 10;
        spark.y = 220 + Math.random() * 20 - 10;
        particles.addChild(spark);
        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 3;
        addParticle(spark, particles, { vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, fadeRate: 0.08 });
      }
    }
  }, []);

  const setMobName = useCallback(() => {}, []);

  const setZone = useCallback((zone: number) => {
    const app = appRef.current;
    const mob = mobRef.current;
    if (!app || !mob) return;
    if (currentZoneRef.current === zone) return;
    currentZoneRef.current = zone;

    const goblinFrames = (app as unknown as Record<string, unknown>)._goblinFrames as PIXI.Texture[] | undefined;

    // Remove old mob
    const parent = mob.parent;
    if (parent) parent.removeChild(mob);

    let newMob: PIXI.AnimatedSprite | PIXI.Sprite;
    if (zone === 0 && goblinFrames && goblinFrames.length > 0) {
      const animMob = new PIXI.AnimatedSprite(goblinFrames);
      animMob.animationSpeed = 0.08;
      animMob.scale.set(0.45);
      animMob.play();
      newMob = animMob;
    } else {
      const mobSpriteData = MOB_SPRITES[zone] || LUTIN_SPRITE;
      const newTexture = createSpriteTexture(mobSpriteData, app, 4);
      newMob = new PIXI.Sprite(newTexture);
      newMob.scale.x = -1;
    }
    newMob.anchor.set(0.5, 1);
    newMob.x = 380; newMob.y = 270;
    if (parent) parent.addChild(newMob);
    mobRef.current = newMob;
  }, []);

  useEffect(() => {
    if (!containerRef.current) return;
    let cancelled = false;

    const attachCanvas = (app: PIXI.Application) => {
      if (cancelled || !containerRef.current) return;
      app.canvas.style.width = '100%';
      app.canvas.style.height = 'auto';
      if (containerRef.current.children.length === 0) {
        containerRef.current.appendChild(app.canvas);
      }
      appRef.current = app;
      onReadyRef.current?.({ castSpell, hitMob, setMobName, setZone });
    };

    const initPixi = async () => {
      if (containerRef.current) containerRef.current.innerHTML = '';

      const app = new PIXI.Application();
      await app.init({ width: 500, height: 300, backgroundColor: 0x0a0a12, antialias: false, resolution: Math.min(window.devicePixelRatio || 1, 2), autoDensity: true, powerPreference: 'high-performance' });

      globalPixiApp = app;
      if (containerRef.current) {
        app.canvas.style.width = '100%';
        app.canvas.style.height = 'auto';
        containerRef.current.appendChild(app.canvas);
        appRef.current = app;
      }

      const background = drawDungeonBackground(app);
      app.stage.addChild(background);

      // Load wizard individual frames (pre-split by Python script)
      const wizardFrames: PIXI.Texture[] = [];
      for (let i = 1; i <= 8; i++) {
        try {
          const tex = await PIXI.Assets.load(`/sprites/wizard_${i}.png`);
          wizardFrames.push(tex);
        } catch (e) { console.warn(`[BattleScene] Failed to load wizard_${i}.png`, e); }
      }

      // Idle frames: 1-6, Cast frames: 7-8
      const idleFrames = wizardFrames.slice(0, 6);
      const castFrames = wizardFrames.slice(6, 8);

      const wizard = new PIXI.AnimatedSprite(idleFrames);
      wizard.anchor.set(0.5, 1);
      wizard.x = 80; wizard.y = 260;
      wizard.animationSpeed = 0.08;
      wizard.scale.set(0.55);
      wizard.play();
      app.stage.addChild(wizard);
      wizardRef.current = wizard;

      // Store cast frames for spell animation
      (wizard as unknown as Record<string, unknown>)._idleFrames = idleFrames;
      (wizard as unknown as Record<string, unknown>)._castFrames = castFrames;

      let wizardTime = 0;
      app.ticker.add((t) => { wizardTime += t.deltaTime * 0.03; wizard.y = 260 + Math.sin(wizardTime) * 2; });

      const particles = new PIXI.Container();
      app.stage.addChild(particles);
      particlesRef.current = particles;

      // Setup centralized particle ticker (single callback instead of 30-50+ rAF loops)
      setupParticleTicker(app);

      // Load goblin frames for zone 0
      const goblinFrames: PIXI.Texture[] = [];
      for (let i = 1; i <= 9; i++) {
        try {
          const tex = await PIXI.Assets.load(`/sprites/goblin_${i}.png`);
          goblinFrames.push(tex);
        } catch (e) { console.warn(`[BattleScene] Failed to load goblin_${i}.png`, e); }
      }
      (app as unknown as Record<string, unknown>)._goblinFrames = goblinFrames;

      let mob: PIXI.AnimatedSprite | PIXI.Sprite;
      if (currentZone === 0 && goblinFrames.length > 0) {
        const animMob = new PIXI.AnimatedSprite(goblinFrames);
        animMob.animationSpeed = 0.08;
        animMob.scale.set(0.45);
        animMob.play();
        mob = animMob;
      } else {
        const mobSpriteData = MOB_SPRITES[currentZone] || LUTIN_SPRITE;
        const mobTexture = createSpriteTexture(mobSpriteData, app, 4);
        mob = new PIXI.Sprite(mobTexture);
        mob.scale.x = -1;
      }
      mob.anchor.set(0.5, 1);
      mob.x = 380; mob.y = 270;
      app.stage.addChild(mob);
      mobRef.current = mob;

      let mobTime = 0;
      app.ticker.add((t) => { mobTime += t.deltaTime * 0.05; mob.y = 270 + Math.sin(mobTime) * 3; });

    };

    const setup = async () => {
      // Already initialized - just re-attach canvas
      if (globalPixiApp) {
        attachCanvas(globalPixiApp);
        return;
      }
      // Init in progress (Strict Mode re-mount) - wait for it
      if (globalInitPromise) {
        await globalInitPromise;
        if (!cancelled && globalPixiApp) attachCanvas(globalPixiApp);
        return;
      }
      // Fresh initialization
      globalInitPromise = initPixi().catch((err) => {
        console.error('[BattleScene] Failed to initialize:', err);
        globalPixiApp = null;
        globalInitPromise = null;
      });
      await globalInitPromise;
      if (!cancelled && globalPixiApp) attachCanvas(globalPixiApp);
    };

    setup();

    return () => {
      cancelled = true;
      if (containerRef.current) containerRef.current.innerHTML = '';
      appRef.current = null;
      _particles.length = 0;
      _projectiles.length = 0;
    };
  }, [castSpell, hitMob, setMobName, setZone]);

  return (
    <div ref={containerRef} style={{ width: '100%', maxWidth: '500px', margin: '0 auto', borderRadius: '4px', overflow: 'hidden', border: '3px solid #1a1a2e', boxShadow: '0 0 20px rgba(0,0,0,0.8)', imageRendering: 'pixelated' }} />
  );
}
